[Unit]
Description=VNF Broker Service
Documentation=https://github.com/alexandremattioli/Build/tree/feature/vnf-broker
After=network.target redis-server.service
Wants=redis-server.service

[Service]
Type=notify
User={{ broker_user }}
Group={{ broker_user }}
WorkingDirectory={{ broker_home }}/app
EnvironmentFile=/etc/vnfbroker/broker.env

ExecStart={{ broker_home }}/venv/bin/python -m uvicorn broker:app \
    --host ${BROKER_HOST} \
    --port ${BROKER_PORT} \
    --workers ${BROKER_WORKERS} \
    --ssl-keyfile ${TLS_KEY_PATH} \
    --ssl-certfile ${TLS_CERT_PATH} \
    --log-config {{ broker_home }}/app/logging.yaml

# Security hardening
NoNewPrivileges=true
PrivateTmp=true
ProtectSystem=strict
ProtectHome=true
ReadWritePaths={{ broker_home }}/logs
ProtectKernelTunables=true
ProtectKernelModules=true
ProtectControlGroups=true
RestrictRealtime=true
RestrictNamespaces=true
RestrictSUIDSGID=true
LockPersonality=true

# Process management
Restart=on-failure
RestartSec=10
TimeoutStartSec=60
TimeoutStopSec=30
KillMode=mixed
KillSignal=SIGTERM

# Resource limits
LimitNOFILE=65536
MemoryLimit=512M
CPUQuota=200%

# Logging
StandardOutput=journal
StandardError=journal
SyslogIdentifier=vnfbroker

[Install]
WantedBy=multi-user.target
