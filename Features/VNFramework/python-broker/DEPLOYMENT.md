# VNF Broker Deployment Guide

## Redis Integration - Build2 Implementation

This enhanced version implements Redis-backed idempotency per Build1 requirements:
- [OK] Redis connection pooling
- [OK] 24h TTL for idempotency keys
- [OK] RS256 JWT verification
- [OK] Persistent cache across restarts

## Prerequisites

1. **Python 3.8+** on Virtual Router
2. **Redis 6.0+** running on VR or management network
3. **RS256 keypair** generated by Build1

## Installation Steps

### 1. Install Redis

```bash
# On Virtual Router or accessible host
apt-get update && apt-get install -y redis-server
systemctl enable redis-server
systemctl start redis-server
```

### 2. Install Python Dependencies

```bash
pip3 install -r requirements.txt
```

### 3. Create Directories

```bash
mkdir -p /opt/vnf-broker
mkdir -p /etc/vnf-broker
mkdir -p /var/log/vnf-broker
```

### 4. Deploy Files

```bash
cp vnf_broker_redis.py /opt/vnf-broker/
cp config.sample.json /etc/vnf-broker/config.json
chmod 600 /etc/vnf-broker/config.json
```

### 5. Configure JWT Public Key

```bash
# Copy RS256 public key from Build1
# This will be provided by Build1 per their message
cat > /etc/vnf-broker/jwt_public.pem << 'EOF'
-----BEGIN PUBLIC KEY-----
<Build1 will provide this>
-----END PUBLIC KEY-----
EOF
chmod 600 /etc/vnf-broker/jwt_public.pem
```

### 6. Configure Redis Connection

Edit `/etc/vnf-broker/config.json`:
```json
{
  "REDIS_HOST": "localhost",
  "REDIS_PORT": 6379,
  "REDIS_PASSWORD": null,
  "IDEMPOTENCY_TTL_SECONDS": 86400
}
```

### 7. Install Systemd Service

```bash
cp vnf-broker.service /etc/systemd/system/
systemctl daemon-reload
systemctl enable vnf-broker
systemctl start vnf-broker
```

### 8. Verify Status

```bash
systemctl status vnf-broker
journalctl -u vnf-broker -f

# Test health endpoint
curl http://localhost:8443/health
```

## Testing Idempotency

```bash
# First request - executes operation
curl -X POST http://localhost:8443/api/vnf/firewall/create \
  -H "Authorization: Bearer <JWT_TOKEN>" \
  -H "Content-Type: application/json" \
  -d '{
    "vnfInstanceId": "test-vm-001",
    "ruleId": "rule-001",
    "action": "allow",
    "protocol": "tcp",
    "sourceIp": "10.0.0.0/24",
    "destinationIp": "192.168.1.0/24",
    "destinationPort": 443
  }'

# Second identical request - returns cached response
# Check logs: should see "Idempotency cache HIT"
```

## Redis Monitoring

```bash
# Check Redis connection
redis-cli ping

# Monitor idempotency keys
redis-cli KEYS "idempotency:*"

# Check TTL on a key
redis-cli TTL "idempotency:firewall.create:abc123..."

# View cached response
redis-cli GET "idempotency:firewall.create:abc123..."
```

## Troubleshooting

### Broker won't start
```bash
# Check Redis is running
systemctl status redis-server

# Check JWT public key exists
ls -la /etc/vnf-broker/jwt_public.pem

# Check logs
journalctl -u vnf-broker -n 50
```

### Redis connection errors
```bash
# Test Redis connectivity
redis-cli -h <REDIS_HOST> -p <REDIS_PORT> ping

# Check firewall rules
iptables -L -n | grep 6379
```

### JWT verification fails
```bash
# Verify RS256 public key format
openssl rsa -pubin -in /etc/vnf-broker/jwt_public.pem -text -noout

# Check JWT token (decode without verification)
python3 -c "import jwt; print(jwt.decode('<token>', options={'verify_signature': False}))"
```

## Performance Notes

- **Redis Connection Pool**: Max 10 connections (configurable)
- **Idempotency TTL**: 24 hours (86400 seconds)
- **Request Timeout**: 30 seconds to VNF devices
- **Health Check**: `/health` endpoint includes Redis status

## Security Considerations

1. **RS256 JWT**: Public key verification (no shared secrets)
2. **Redis Auth**: Use `REDIS_PASSWORD` in production
3. **TLS**: Broker uses HTTPS (self-signed or CA-signed cert)
4. **Firewall**: Restrict access to management IPs only

## Build1 Handoff Checklist

- [ ] RS256 keypair generated and public key shared
- [ ] Redis deployed and accessible
- [ ] broker.py with requirements.txt handed off
- [ ] Sample config provided with correct IPs
- [ ] Unit tests coverage included
- [ ] .deb/systemd bundle created by Build1

## Next Steps (per Build1 msg_1762254639_7339)

1. [OK] Redis integration complete
2. ⏳ Await RS256 public cert from Build1 (2025-11-05)
3. ⏳ Packaging: Build1 owns .deb/systemd bundle
4. ⏳ pfSense lab credentials (ETA 2025-11-05T15:00Z)
5. ⏳ Integration testing with pfSense
