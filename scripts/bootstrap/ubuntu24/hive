#!/usr/bin/env python3
"""Hive CLI - inspect and manage build cluster."""
import json, argparse, subprocess, sys, os

parser = argparse.ArgumentParser(description='Manage the build hive')
parser.add_argument('command', choices=['status', 'peers', 'identity', 'reset'],
                    help='Command to execute')
args = parser.parse_args()

def load_json(path):
    try:
        with open(path) as f:
            return json.load(f)
    except FileNotFoundError:
        return None
    except json.JSONDecodeError as e:
        print(f"Error reading {path}: {e}", file=sys.stderr)
        return None

if args.command == 'status':
    identity = load_json('/var/lib/build/identity.json')
    peers = load_json('/var/lib/build/peers.json')
    
    if identity:
        print(f"Role:        {identity.get('role', '<unknown>')}")
        print(f"Assigned by: {', '.join(identity.get('assigned_by', []))}")
        print(f"Assigned at: {identity.get('assigned_at', '<unknown>')}")
        if identity.get('packages'):
            print(f"Packages:    {', '.join(identity['packages'])}")
    else:
        print("No identity assigned yet")
    
    if peers:
        peer_count = len(peers.get('peers', []))
        print(f"Peers:       {peer_count}")
        self_info = peers.get('self', {})
        print(f"Hostname:    {self_info.get('hostname', '<unknown>')}")
        print(f"IP:          {self_info.get('primary_ip', '<unknown>')}")
    else:
        print("No peer data available")

elif args.command == 'peers':
    peers = load_json('/var/lib/build/peers.json')
    if peers and peers.get('peers'):
        print(f"{'Hostname':<20} {'IP':<15} {'Role':<15}")
        print("-" * 50)
        for p in peers['peers']:
            print(f"{p.get('hostname','<unknown>'):<20} {p.get('ip','<unknown>'):<15} {p.get('role','<unknown>'):<15}")
    else:
        print("No peers discovered")

elif args.command == 'identity':
    identity = load_json('/var/lib/build/identity.json')
    if identity:
        print(json.dumps(identity, indent=2))
    else:
        print("No identity file found")

elif args.command == 'reset':
    if os.geteuid() != 0:
        print("Error: reset requires root privileges", file=sys.stderr)
        sys.exit(1)
    
    identity_path = '/var/lib/build/identity.json'
    if os.path.exists(identity_path):
        os.remove(identity_path)
        print("Identity removed")
    
    print("Restarting build-agent...")
    subprocess.run(['systemctl', 'restart', 'build-agent'])
    print("Done. Check logs: journalctl -u build-agent -f")
