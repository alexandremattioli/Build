#!/bin/bash
# cm - Check Messages

# Detect server
if [ -d "/Builder1/Build" ]; then
    SERVER="build1"
elif [ -d "/Builder2/Build" ]; then
    SERVER="build2"
else
    SERVER="build1"
fi

LOG="/var/log/build-messages-${SERVER}.log"

# Format timestamps
fmt() { perl -pe 's/(\d{4}-\d{2}-\d{2})T(\d{2}:\d{2}:\d{2})Z/\1 @ \2 /g'; }

# Condense to headers only
condense() { grep -E "^===|^\[INFO\]|^\[WARN\]|^\[ERROR\]|^Subject:|^Time:|^---"; }

# Parse args
VERBOSE=false
FOLLOW=false
LINES=20

while [ $# -gt 0 ]; do
    case "$1" in
        -f) FOLLOW=true; shift ;;
        -v) VERBOSE=true; shift ;;
        -fv|-vf) FOLLOW=true; VERBOSE=true; shift ;;
        [0-9]*) LINES="$1"; shift ;;
        *) shift ;;
    esac
done

# Execute
if [ "$FOLLOW" = true ]; then
    if [ "$VERBOSE" = true ]; then
        echo "Following messages for ${SERVER} in VERBOSE mode (Ctrl+C to stop)..."
        echo "--- Recent messages ---"
        tail -n 20 "$LOG" | fmt
        echo ""
        echo "--- Following new messages ---"
        tail -f "$LOG" | fmt
    else
        echo "Following messages for ${SERVER} (Ctrl+C to stop)..."
        echo "--- Recent messages ---"
        tail -n 20 "$LOG" | fmt | condense
        echo ""
        echo "--- Following new messages ---"
        tail -f "$LOG" | fmt | condense --line-buffered
    fi
elif [ "$VERBOSE" = true ]; then
    tail -n "$LINES" "$LOG" | fmt
else
    echo "Messages for ${SERVER} (condensed - use 'cm -v' for full):"
    echo "---"
    tail -n "$LINES" "$LOG" | fmt | condense
    echo "---"
fi
